# 🎯 TimeScore V5.0 - 积分兑换系统

## 版本更新概述
本版本针对TimeScore（时间管理计分应用）的主界面和后端数据结构进行优化，新增积分兑换系统，旨在将虚拟积分转化为真实动机（原有奖励兑换想法的实现）。核心变化包括：
- 主界面添加“积分兑换”入口（按钮/Tab），点击进入兑换页面。
- 兑换页面：两个主要选项——“新增心愿”（输入名称、所需积分）和“兑换心愿”（列表选择、消耗积分）。
- 数据持久化：修改数据结构，支持心愿列表存储（本地DB），包括ID、名称、积分成本、状态（未兑换/已兑换/进度）。
- 整合现有系统：积分来源自行为记录（V4.0计算），兑换时扣减总积分。失败时提示（积分不足）。
- CLI优先实现：使用命令行菜单模拟界面（e.g., 输入数字选择选项），SQLite持久化数据。后续迁移iOS（SwiftUI表单/列表视图）。
- 平衡机制：防滥用（如积分成本下限），新手引导（首兑换奖金）。

此文档可作为大模型（如LLM）理解和实现的Prompt基础：**"基于以下TimeScore V5.0积分兑换规格，实现一个命令行时间管理应用的兑换模块。输入用户记录和现有积分（JSON格式）。系统需处理新增/兑换心愿，更新SQLite数据库（表：wishes with id, name, cost, status, user_id）。生成CLI菜单输出，包括心愿列表和积分余额。iOS迁移提示：用SwiftUI List/Form实现互动，CoreData持久化。输出格式为文本菜单+更新JSON。"**

---

## 一、积分兑换系统核心规则（V5.0）

### 1. 系统架构与用户流程
- **主界面入口**：首页仪表盘（V4.0）添加“积分兑换”按钮。显示当前总积分（e.g., “积分:560 | 兑换中心”）。
- **兑换页面**：分两个Tab/选项（CLI用数字菜单：1. 新增心愿 2. 兑换心愿 0. 返回）。
  - **新增心愿**：表单输入——心愿名称（字符串，限50字）、所需积分（整数，>0，下限100防小额刷）。系统自动生成ID，状态“未兑换”。
  - **兑换心愿**：显示心愿列表（名称、成本、进度=当前积分/成本）。选择ID，检查积分>=成本，扣减积分，更新状态“已兑换”。成功后触发庆祝（CLI文本动画，iOS粒子效果）。
- **积分扣减逻辑**：总积分 -= 成本。更新全局积分（原有行为积分累加）。
- **错误处理**：积分不足→提示“需X积分，继续努力！”；无效输入→重试。
- **持久化**：所有操作实时保存，避免丢失。CLI用SQLite，iOS用CoreData。

### 2. 数据结构修改
- **原有数据结构扩展**：原有记录表（behaviors: id, grade, duration, mood, score, energy_change, timestamp, notes）。
- **新表：wishes（心愿表）**：
  - **字段**：
    | 字段名 | 类型 | 描述 | 默认值 |
    |--------|------|------|--------|
    | id | INTEGER | 唯一ID（主键） | AUTO |
    | user_id | INTEGER | 用户ID（多用户支持） | 1 |
    | name | TEXT | 心愿名称 | - |
    | cost | INTEGER | 所需积分 | - |
    | status | TEXT | 状态（pending/ redeemed/ archived） | pending |
    | created_at | TIMESTAMP | 创建时间 | CURRENT |
    | redeemed_at | TIMESTAMP | 兑换时间 | NULL |
    | progress | REAL | 进度（当前积分/成本，计算时更新） | 0.0 |
- **用户表（可选扩展）**：users: id, total_points（总积分，实时更新）。
- **关系**：wishes外键user_id链接users。行为记录更新total_points。
- **迁移脚本**：CLI用SQL（CREATE TABLE IF NOT EXISTS wishes...）；iOS用CoreData migration。
- **数据安全**：本地加密（iOS Keychain），备份支持（CLI JSON导出）。

### 3. 平衡与上瘾机制
- **成本建议**：系统AI提示（基于日均积分，e.g., “建议500-5000分，小愿速成”）。
- **进度可视化**：列表中进度条（CLI ASCII [■■■■□□] 40%；iOS ProgressView）。
- **奖励联动**：兑换后+额外积分（5%返还，鼓励循环）；首心愿免费小额（新手）。
- **防滥用**：单日兑换限3次；成本<100无效；已兑换心愿可归档（不删）。
- **整合可视化（V4.0）**：仪表盘显示“可兑换心愿:2/5”；RPG中“心愿徽章”解锁。

---

## 二、用户交互与实现细节
- **CLI原型**：Python脚本，菜单循环（input选择）。示例：
  ```
  TimeScore 主界面
  当前积分: 560.5
  1. 记录行为
  2. 查看可视化
  3. 积分兑换
  0. 退出

  > 3

  积分兑换中心
  1. 新增心愿
  2. 兑换心愿 (可用:2)
  0. 返回

  > 1
  心愿名称: 买新书
  所需积分: 500
  添加成功！ID:1

  > 2
  心愿列表:
  1. 买新书 - 500分 [■■■■□□] 100% (积分够)
  2. 旅行 - 2000分 [■■□□□□] 28%
  选择ID:1
  兑换成功！剩余积分:60.5
  庆祝: 🎉 享受你的新书！ 🎉
  ```
  用sqlite3库持久化。
- **iOS迁移**：SwiftUI NavigationView，主Tab“兑换”。Form新增，List兑换（Button扣减）。动画：Confetti on redeem。
- **输入验证**：名称非空，积分正整数。

---

## 三、实例：程序员小明的使用（V5.0）
### 小明当前：积分560.5，无心愿。
### 操作：
1. 主界面→积分兑换→新增：名称“周末咖啡”，积分300。DB插入：id=1, name=周末咖啡, cost=300, status=pending。
2. 新增：名称“新键盘”，积分800。
3. 兑换：列表显示[周末咖啡 300 [■■■■■■] 100%] [新键盘 800 [■■■■□□] 70%]。选1，扣300，剩余260.5，status=redeemed, redeemed_at=now。
### 日终：可视化仪表盘更新“已兑换:1”，RPG解锁“愿望实现者Lv.1”。

**小明反馈**："积分终于有用武之地！看到进度条，动力满满。"

---

## 四、防滥用与平衡（V5.0优化）
- **积分通胀保护**：成本自动上调（基于历史积分率+10%）。
- **归档功能**：已兑换心愿移到历史列表。
- **通知**：积分达90%成本时，推送“快兑换啦！”（iOS LocalNotification）。
- **多用户**：扩展user_id，支持家庭共享。

---

## 五、我的额外改进建议
以上设计合理、可实现（CLI<150行，iOS扩展现有App）。以下优化：
1. **新增心愿**：加类别（e.g., 休闲/学习），用于分类列表。
2. **兑换**：加确认弹窗，防误操作。
3. **数据结构**：加description字段（可选描述），丰富列表显示。
4. **可视化整合**：热力图标注兑换日（星星图标）。
5. **AI增强**：基于行为历史，建议心愿（e.g., “多S级？建议学习相关心愿”）。

额外提案：
- **分享**：兑换成功分享截图。
- **测试**：模拟用户积分流，检查持久化（e.g., 重启CLI数据不丢）。